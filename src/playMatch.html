<!DOCTYPE html>

<html>
<head>
	<meta name = "viewport" content = "width=device-width">
	<link rel="stylesheet" type="text/css" href="css/style.css"/>
	<link rel="stylesheet" type="text/css" href="css/jquery.qtip.css"/>
	<script type="text/javascript" src="js/jquery-1.7.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
	<script type="text/javascript" src="js/jquery.qtip.js"></script>
	<script type="text/javascript" src="js/util.js"></script>
	<script type="text/javascript" src="js/MemberList.js"></script>
	<script type="text/javascript">
	   	var memberList, currentMode;
	    var matches, p1, p2, p1_AI, p2_AI;
	   	p1 = "{{userID}}";   p2 = "{{opponent}}";
	   	var p1_color = "paleGreen";   
	    var p2_color = "violetPink";  
	    var playerColor = {};
	    var canvasElement, ctx;
//	    var {{p1}}_AI = JSON.parse("{{p1_AI}}".replace(/&quot;/g,'"'));
//	    var {{p2}}_AI = JSON.parse("{{p2_AI}}".replace(/&quot;/g,'"'));
//		var matches = JSON.parse("{{ matches }}".replace(/&quot;/g,'"'));

		var currentRound = 0;    
      
		function init(opponent) {
	       		if(p1=="Guest") {
	       			alert("Log in first.");
	       			return;
	       		}
				$("#matches").empty();
				$("#desc").empty();
				p2=opponent;
				currentRound = 0;
				playerColor[p1]=p1_color;   playerColor[p2] = p2_color;
		}
       	// request server to run match and get response
       	function runMatch(pl1,pl2) {
       		if(pl1=="Guest") {
       			return;
       		}
       		$.get('ajaxCall',{ action:'runMatch', p1:pl1, p2:pl2 }, function(data) {

       			var res = JSON.parse(data);
       			var result = res.result;

       			matches = result.matches;
       			p1_AI = result.AI[p1];
       			p2_AI = result.AI[p2];
       			// count who wins how many times
       			var p1_wins = 0;  var p2_wins= 0;  var tie_games = 0;
       			$.each(matches, function(i,match) {
       				if (match.winner==result.players.p1) p1_wins++;
       				if (match.winner==result.players.p2) p2_wins++;
       				if (match.winner=="Tie Game") tie_games++;
       			});
       			//  show the player's strategy
       			var aiDIV = $("#desc").append("<DIV id='p1_ai_div' class='clearfix' style='clear:both;'><ul id='p1_ai' style='list-style-type:none;padding-left:0px;margin:0px;'></ul><div style='clear:both;'></div></DIV>");
       			$(aiDIV).prepend("<h2 style='float:left;'>"+p1+"'s AI</h2><div id='button_ai_edit' style='float:left; margin:2px 0px 0px 10px; cursor:pointer;'><span class='icon_edit'>&nbsp;</span><span style='float:left; margin:4px 0px 0px 2px; font-weight:bold;'>Edit</span></span>");
       			$.each(p1_AI, function(i,strategy) {
       				$(aiDIV).find("#p1_ai").append("<li class='ai_item'>"+strategy+"</li>");
       			});
       			$("#p1_ai").sortable({
       				update : function(event, ui) {
       					var codeList = [];
       					$("#p1_ai li").each(function(i,e) {
       						var code = $(e).text();
       						codeList.push(code);
       					});
       			    	$.ajax({
       			    		type : "GET",
       			    		url: "/ajaxTrainer",
       			    		async: true,
       			    		data: 	{ 	action: 'changeOrder',
       			    					player: p1,
       			    					game: 'tictactoe',
       			    					newStrategy : JSON.stringify(codeList)
       			    				},
       			    		success: function(response) {
       			    			init(p2);
       			    			runMatch(p1,p2);
       			    		}
       			    	});
       				}
       			});
       			$("#p1_ai").disableSelection();
       			$("#button_ai_edit").click(function() {
       				
       			});
       			// show description of the match
       			$("#desc").append("<h2 style='margin-top:15px;'>Result of 30 matches</h2>");
       			var html = 	"<SPAN style='background-color:"+getColor(playerColor[result.players.p1],1)+"; color:white; padding:0px 4px 0px 4px; -moz-border-radius: 4px; border-radius:4px;'>"+result.players.p1+"</SPAN>"
       					+	"<SPAN style='margin:0 10px 0 10px;'>"+p1_wins+"</SPAN>"
       					+	" : "
       					+	"<SPAN style='margin:0 10px 0 10px;'>"+p2_wins+"</SPAN>"
       					+	"<SPAN style='background-color:"+getColor(playerColor[result.players.p2],1)+"; color:white; padding:0px 4px 0px 4px; -moz-border-radius: 4px; border-radius:4px;'>"+result.players.p2+"</SPAN>"
       					+	"<SPAN style='margin:0 10px 0 20px;'>and "+tie_games+" tie games</SPAN>";
     
       			$("#desc").append("<DIV style='font-size:21px; margin:10px;'>"+html+"</DIV>");
       			
       		});
       	}
       	function createMiniBoard_singleRound(match,iR) {
       		var movesInOrder = [[0,0,0],[0,0,0],[0,0,0]];
            var strategyInOrder = [["","",""],["","",""],["","",""]];
            $(match.history).each(function(bi,turn) {
            	if (turn.loc==undefined) return;
                movesInOrder[turn.loc[0]][turn.loc[1]]=bi+1;
                strategyInOrder[turn.loc[0]][turn.loc[1]]=turn.message;
            });
            var turn = match.history[iR];
            var matchBoard = createMiniBoard(turn.board,turn.message,turn.loc,movesInOrder,strategyInOrder,false);
            return matchBoard;
       	}
       
		function createMiniBoard(board,st,loc,movesInOrder,strategyInOrder,showStrategy) {
			var miniBoard = $("<div class='miniboard'></div>"); 
			if (showStrategy) $(miniBoard).append("<div id='strategy' style='font-size:12px; font-family:Helvetica; '>"+"</div>");
			else  $(miniBoard).append("<div id='strategy' style='font-size:12px; font-family:Helvetica'></div>");
			var boardDiv = $("<div></div>");
				$(board).each( function(ir,r) {
					//alert(r);
					var row = $("<div></div>");
					$(r).each( function(ic,c) {
					    var col = $("<div class='review_cell "+ir+"_"+ic+"'><p>"+movesInOrder[ir][ic]+"</p></div>");
						if (loc!=undefined && loc[0]==ir && loc[1]==ic) { // if it's the latest move
							if (c==p1) $(col).css("background-color",color.paleGreen);  
                           else if (c==p2) $(col).css("background-color",color.violetPink);
						} else {
                           if (c==p1) $(col).css("background-color",getColor("paleGreen",0.3));  
                           else if (c==p2) $(col).css("background-color",getColor("violetPink",0.3));
						}		
						if(strategyInOrder[ir][ic]!="" && (c==p1 || c==p2)) $(col).qtip({content:strategyInOrder[ir][ic]});
						$(row).append(col);
					});
					$(row).append("<div style='clear:both'></div>");
					$(boardDiv).append(row);
				});
			if (st=='takeWin') {
				$(findWinningCells(board)).each(function(i,wloc) {
					$(boardDiv).find("."+wloc[0]+"_"+wloc[1]).css('border','2px solid black');
				});
           }			
			$(boardDiv).css('border','2px solid white');
			$(boardDiv).append("<div style='clear:both'></div>");
			$(miniBoard).append(boardDiv);
			$(miniBoard).append("<div style='clear:both;'></div>");
			return miniBoard;
		}
		
		function showMatchesAsList(matchList) {
			currentMode = "list";
		    $("#matches").empty();
           $(matchList).each( function(i,m) {
               //alert(e.message);
               var matchDIV = $("<div style='clear:both; margin:10px 0 10px 0; border-top:2px dotted'></div>");
               var p1tag = "<span style='background-color:"+getColor(playerColor[p1],0.6)+";border-radius:2px; padding:1px 3px 1px 3px;'>"+p1+"</span>";
               var p2tag = "<span style='background-color:"+getColor(playerColor[p2],0.6)+";border-radius:2px; padding:1px 3px 1px 3px;'>"+p2+"</span>";
               if (m.winner==p1) $(matchDIV).append("<div><span>"+"<div class='icon_star' style=''></div>"+p1tag+" vs. "+p2tag+"</span></div>");
               else if(m.winner==p2) $(matchDIV).append("<div><span>"+p1tag+" vs. "+p2tag+"<div class='icon_star' style=''></div>"+"</span></div>");
               var movesInOrder = [[0,0,0],[0,0,0],[0,0,0]];
               var strategyInOrder = [["","",""],["","",""],["","",""]];
               $(m.history).each(function(bi,turn) {
               	if (turn.loc==undefined) return;
                   movesInOrder[turn.loc[0]][turn.loc[1]]=bi+1;
                   strategyInOrder[turn.loc[0]][turn.loc[1]]=turn.message;
               });
//               alert(movesInOrder);
               $(m.history).each(function(bi,turn) {
                   var matchBoard = createMiniBoard(turn.board,turn.message,turn.loc,movesInOrder,strategyInOrder,true);
                   $(matchDIV).append(matchBoard);
               });
               $(matchDIV).append("<div style='clear:both'/>");
               $("#matches").append(matchDIV);
           });
           colorizeUser();
		}
		function showMatchesAsAnimation(matchList) {
			currentMode = "animation";
		  $("#matches").empty();
		  $("#matches").append("<div><input type='button' value='<' onclick='prev();'/><input type='button' value='>' onclick='next();'/>"+currentRound+"</div>");
		  $(matchList).each( function(i,m) {
		      var matchDIV = $("<div id='match_"+i+"' class='match'></div>");
		      matchDIV.append("<div style='font-size:11px;'>match "+i+"</div>");
		      var turn = m.history[currentRound];
		      if (turn==undefined) turn=m.history[m.history.length-1];
             var movesInOrder = [[0,0,0],[0,0,0],[0,0,0]];
             var strategyInOrder = [["","",""],["","",""],["","",""]];
             $(m.history).each(function(bi,turn) {
             	if (turn.loc==undefined) return;
                 movesInOrder[turn.loc[0]][turn.loc[1]]=bi+1;
                 strategyInOrder[turn.loc[0]][turn.loc[1]]=turn.message;
             });
		      var matchBoard = createMiniBoard(turn.board, turn.message, turn.loc,movesInOrder,strategyInOrder,true);
		      $(matchDIV).append(matchBoard);
		      $("#matches").append(matchDIV);
		  });
		}
		function prev() {
		  currentRound -=1; 
		  if (currentRound<0)  currentRound=0;
		  showMatchesAsAnimation(matches);
		}
		function next() {
         currentRound +=1; 
         if (currentRound>8)  currentRound=8;
         showMatchesAsAnimation(matches);
		}
		
		function showMatchesAsGroups(matchList) {
			currentMode = "group";
			$("#matches").empty();
			$("#matches").append("<div id='winningGames' style='clear:both; margin:10px;'><div>Winning games</div></div>");
			$("#matches").append("<div id='losingGames' style='clear:both; margin:10px;'><div>Losing games</div></div>");
			$("#matches").append("<div id='tieGames' style='clear:both; margin:10px;'><div>Tie games</div></div>");
			$(matchList).each( function(i,m) {
				var matchDIV = $("<div class='match'></div>");
				var lastTurn = m.history[m.history.length-1];
	            var movesInOrder = [[0,0,0],[0,0,0],[0,0,0]];
	            var strategyInOrder = [["","",""],["","",""],["","",""]];
	            $(m.history).each(function(bi,turn) {
	            	if (turn.loc==undefined) return;
	                movesInOrder[turn.loc[0]][turn.loc[1]]=bi+1;
	                strategyInOrder[turn.loc[0]][turn.loc[1]]=turn.message;
	            });
				var matchBoard = createMiniBoard(lastTurn.board, lastTurn.message, lastTurn.loc,movesInOrder,strategyInOrder,false);
				$(matchDIV).append(matchBoard);
				if (m.winner==p1) {
					$("#winningGames").append(matchDIV);
				}
				if (m.winner==p2) {
					$("#losingGames").append(matchDIV);
				}
				if (m.winner=="Tie Game") {
					$("#tieGames").append(matchDIV);
				}
			});
			// lose
			
			// group by last move position
		}
		
		// graph (from left to right). Each column represents round. In a column, similar matches are clustered. Edges between two clusters in adjacent columns are strategy used. 
		function showMatchesAsGraph(matchList) {
			currentMode = "graph";
			$("#matches").empty();
			graph = [];
			// for each round, 
			for(var iR=0;iR<9;iR++) {
				var allMatchesWithinARound = [];
				$(matchList).each( function(iM,match) {
					if (match.history.length>iR)  {
						var b = match.history[iR];
						b.iM = iM;
						allMatchesWithinARound.push(b);
					}
				});
				var cluster = findCluster(allMatchesWithinARound);  // key-value pair.  key:fingerprint of each cluster, value:index of matches in the cluster
				graph.push(cluster);
			}
			
			var result = sugiyama(graph);
			graph = result.graph;
			var cM = result.connectivity;
			// find max, min position (integer)
			var min_pos = 100000;	var max_pos = -100000;
			for(var rI in graph) 
				for(var nodeI in graph[rI]) {
					if (graph[rI][nodeI]['position'] <min_pos) min_pos = graph[rI][nodeI]['position'];
					if (graph[rI][nodeI]['position'] >max_pos) max_pos = graph[rI][nodeI]['position'];
				}
			var gap = max_pos-min_pos;
			var interval = $("#matches").width()/(gap+1);
			var hor_offset = -min_pos*interval;
			
			// draw graph representation
			$(graph).each(function(iR,round){
				var columnDiv = $("<div id='graph_round_"+iR+"' class='matchGraphRound clearfix'></div>");
				$.each(round, function(boardShape,data) { // iterate clusters
					var sampleMatch = matches[data['matches'][0]];  // use the first game in the list, generate representative miniboard
					var matchBoard = createMiniBoard_singleRound(sampleMatch,iR);
					$(matchBoard).removeClass('miniboard');  $(matchBoard).addClass('miniboard_graph');
					$(matchBoard).css("left",data.position*interval+hor_offset);
					$(matchBoard).css("top",0);
					$(matchBoard).attr("shape",boardShape.replace(/"/gi,''));
					var listOfMatches = ""+data.matches;
					$(matchBoard).append("<div style='font-size:9px;'>"+listOfMatches.replace(/,/gi,' ')+"</div>")
					$(columnDiv).append(matchBoard);
				});
				$()
				$("#matches").append(columnDiv);
			});
			// draw lines
			$("#matches").append("<canvas id='canvas' style='position:absolute; top:0px; left:0px;' width='500px' height='500px'></canvas>");
			canvasElement = $("#canvas")[0];
			ctx = canvasElement.getContext("2d");
			ctx.canvas.width = $("#matches").width();
			ctx.canvas.height = $("#matches").height();
			ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
			ctxOffset = $("#canvas").offset();
			offsetX = ctxOffset.left-$("#matches .miniboard:first").width()/2;
			offsetY = ctxOffset.top-$("#matches .miniboard:first").height()/2;	
			$.each(cM, function(iR, round) {
				$.each(round, function(j, connection){
					$.each(connection, function(shapeA, connectedShapesB){
						$.each(connectedShapesB, function(iB, shapeB) {
							var sA = shapeA.replace(/"/gi,''); 	var sB = shapeB.replace(/"/gi,'');
							var offsetA = $('#matches div[shape="'+sA+'"]').offset();
							var offsetB = $('#matches div[shape="'+sB+'"]').offset();
							ctx.moveTo(offsetA.left-offsetX,offsetA.top-offsetY);
							ctx.lineTo(offsetB.left-offsetX,offsetB.top-offsetY);
							ctx.stroke();
						});
					});
				});
			});
			
			
		}
		
		function findCluster(matches) {
			var cluster = {};
			$(matches).each(function(i,match) {
				var variations = getBoardVariations(match.board);
				var patternExist = false;
				var shapeOfBoard = "";
				$(variations).each(function(iV,variation) {
					shapeOfBoard = JSON.stringify(variation);
					if ( shapeOfBoard in cluster) {
						cluster[shapeOfBoard].push(match.iM);
						patternExist = true;
						return false;
					} 
				}); 
				if (patternExist==false) 
					cluster[shapeOfBoard] = [match.iM];
			});
			return cluster;
		}
		

		
		
       // colorize user class with matching colors
       function colorizeUser() {
            $("span.user").each(function(i,d) {
              var userName = $(this).text();
              var colorName = playerColor[userName];
              $(this).css("background-color",getColor(colorName,0.3));      
            }); 
       }

       
       
       // FUNCTIONS FOR GETTING WINNING CELLS //
       isFull = function() {
           for (var i = 0; i < 3; i++)
   			for (var j =0; j<3;j++)
   			    if (board[i][j] == 0)
   			        return false;
           return true;
       }
   	checkCol =function(x,board) {
           if (board[x][0] == board[x][1] && (board[x][0] == board[x][2]) && (board[x][0] != 0)) 
           	return [[x,0],[x,1],[x,2]];
           else return false;
       }
       
       checkRow = function(y,board) {
           if (board[0][y] == board[1][y] && (board[0][y] == board[2][y]) && (board[0][y] != 0))
           	return [[0,y],[1,y],[2,y]];
           else return false;
       }
       
       checkDiag1 = function(board)  {
           if (board[0][0] != 0 && board[0][0] == board[1][1] && board[0][0] == board[2][2]) 
           	return [[0,0],[1,1],[2,2]];
           else return false;
           
       }
       checkDiag2 = function(board) {
           if (board[2][0] != 0 && board[1][1] == board[2][0] && board[0][2] == board[2][0]) 
           	return [[2,0],[1,1],[0,2]];
           else return false;
       }
       function findWinningCells(board) {
           /* Check the top row */
           var result = false;
           for (var i=0; i < 3; i++) {
               result = checkRow(i,board);
               if (result != false)
                   return result;
               result = checkCol(i,board);
               if (result != false)
                   return result;
           }
           result = checkDiag1(board);
           if (result != false)
               return result;
           result = checkDiag2(board);
           if (result != false)
               return result;
           return false;
       }
       
		$(document).ready( function() {
			memberList = new MemberList();
			memberList.init("#memberListDIV");
//			memberList.close();
			
			if(p1=="Guest") {
				$("#welcome").append("Welcome, Guest!  You need to <a href='javascript:openSignIn();'>log in</a> to play matches with others.");
			} else {
				$("#welcome").append("Welcome, "+p1+"! Select an opponent to play matches.");
				if(p2!="") {
					init(p2);
					runMatch(p1,p2);
				}
			}
			
			
//			
//			$("#desc").append("<div> <span style='color:"+getColor(p1_color,1)+"'>{{p1}}</span> : " + {{p1}}_AI +"</div>");
//			$("#desc").append("<div> <span style='color:"+getColor(p2_color,1)+"'>{{p2}}</span> : " + {{p2}}_AI +"</div>");
//			$("#desc").append("<div> RESULT : {{winners}} </div>");
//			
		});
	
	
	</script>

</head>
<body>
	<!-- header -->
		{% include "header.html" %}
	<!-- end of header -->
	<!-- container : main stuff -->
	<div class='container'>
		<div class='pageContent'>
			<div class="wrapper clearfix">
				<div class="innerHeader">
					<div id='desc' style='margin-bottom:10px;'>
						<div id='welcome'></div>
					</div>
					<div id='memberListDIV' style='position:absolute; right:10px; top:10px; width:100px;'></div>
				</div>
				<div>  
				   <input type="button" onclick="showMatchesAsList(matches)" value="List view"/>
				   <input type="button" onclick="showMatchesAsAnimation(matches)" value="Stepwise animation"/>
				   <input type="button" onclick="showMatchesAsGroups(matches)" value="Grouped by winner"/>
				   <input type="button" onclick="showMatchesAsGraph(matches)" value="Game tree graph"/>
				</div>	
				
				<div id='matches' class='clearfix' style='min-height:200px; position:relative;'></div>
				
				
				
			</div> <!--wrapper clearfix-->
		</div>	<!--pageContent-->
		
		
		
		
	
	</div>		<!-- end of container-->

</body>

</html>
	